#!/usr/bin/env ruby

require 'fssm'
require 'colorize'

$root_path = File.expand_path File.join(File.dirname(__FILE__), '..')
$spec_path = File.join $root_path, 'tests/rspec'

def send_system_notification result, msg, interval
  bin_name = result && 'success' || 'failed'
  binpath = File.expand_path "~/.rvm/gems/ruby-1.9.3-p392/bin/terminal-notifier-#{bin_name}"
  `#{binpath} -title #{File.basename(__FILE__)} -message \"#{msg}\nExecuted in #{interval} sec.\"`
end

def log msg
  puts msg.colorize :light_blue
end

def spec filepath
  spec_filepath = File.join $root_path, filepath
  cmd = "cd \"#{$root_path}\"; rspec -I tests/rspec --color --format doc \"#{spec_filepath}\""
  start = Time.now
  result = system(cmd)
  send_system_notification(result, filepath, Time.now - start) rescue nil
end

def changed filepath
  log "The file #{filepath} has changed!"

  if filepath =~ /.*_spec.rb/
    spec filepath
  else
    spec_filepath = "tests/rspec/" + filepath.gsub('.rb', '_spec.rb')
    spec spec_filepath if File.exists?(spec_filepath)
  end
end

def monitor path
  log "Watching for changes #{path}..."
  FSSM.monitor(path, '*.rb') do
    update { |f, r| changed(r) }
  end
end

monitor $root_path
